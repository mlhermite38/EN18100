import React, { useState } from "react";

// Interactive memo for FprEN 18100:2025
// English version, styled with Tailwind (assumes Tailwind is configured in the repo)
// Images expected in ./images/ with the following filenames:
// - fig1_helmet_positioning_index.png
// - fig2_impact_points.png
// - fig3_test_area.png
// - fig4_penetration_test_block.png
// - fig5_retention_test_apparatus.png

export default function InteractiveMemo() {
  const [dark, setDark] = useState(true);
  const [activeModal, setActiveModal] = useState(null);
  const [expanded, setExpanded] = useState({});

  const images = {
    fig1: "/images/fig1_helmet_positioning_index.png",
    fig2: "/images/fig2_impact_points.png",
    fig3: "/images/fig3_test_area.png",
    fig4: "/images/fig4_penetration_test_block.png",
    fig5: "/images/fig5_retention_test_apparatus.png",
  };

  const toggleExpand = (k) => setExpanded((e) => ({ ...e, [k]: !e[k] }));

  return (
    <div className={dark ? "dark" : ""}>
      <div className="min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
        <header className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-800">
          <div className="flex items-center gap-4">
            <div className="rounded p-2 bg-orange-500 text-white font-bold">Petzl</div>
            <h1 className="text-xl font-semibold">Interactive memo — FprEN 18100:2025 (Helmets for ski mountaineers)</h1>
          </div>
          <div className="flex items-center gap-4">
            <button
              onClick={() => setDark(!dark)}
              className="px-3 py-1 rounded-md border dark:border-gray-700"
            >
              {dark ? "Dark" : "Light"}
            </button>
            <a href="#guide" className="text-sm opacity-80">Quick guide</a>
          </div>
        </header>

        <main className="p-6 max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Left nav */}
          <nav className="lg:col-span-1 sticky top-6 self-start">
            <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 shadow-sm">
              <h2 className="font-semibold mb-2">Sections</h2>
              <ul className="space-y-2 text-sm">
                <li><a href="#intro" className="block hover:underline">Intro & Scope</a></li>
                <li><a href="#terms" className="block hover:underline">Terms & Figures</a></li>
                <li><a href="#construction" className="block hover:underline">Design & Construction</a></li>
                <li><a href="#performance" className="block hover:underline">Performance requirements</a></li>
                <li><a href="#methods" className="block hover:underline">Test methods (interactive)</a></li>
                <li><a href="#marking" className="block hover:underline">Marking & Info</a></li>
                <li><a href="#annexa" className="block hover:underline">Annex A (thermal)</a></li>
              </ul>
            </div>

            <div className="mt-4 bg-white dark:bg-gray-900 rounded-lg p-4 border border-dashed border-gray-200 dark:border-gray-800 text-sm">
              <strong>Images</strong>
              <p className="mt-2 text-xs">Place the standard figures in <code>/images/</code> with these names:</p>
              <ul className="text-xs mt-2 space-y-1">
                <li>fig1_helmet_positioning_index.png</li>
                <li>fig2_impact_points.png</li>
                <li>fig3_test_area.png</li>
                <li>fig4_penetration_test_block.png</li>
                <li>fig5_retention_test_apparatus.png</li>
              </ul>
            </div>
          </nav>

          {/* Main content */}
          <section id="content" className="lg:col-span-3 space-y-6">
            <section id="intro" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-2xl font-semibold mb-2">Introduction & Scope</h2>
              <p className="leading-relaxed">This interactive memo presents the specification, requirements and test methods defined in FprEN 18100:2025 for helmets intended for ski mountaineering. Use the left menu to navigate. Click figures to enlarge; hover for quick facts.</p>
            </section>

            <section id="terms" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <div className="flex items-start justify-between">
                <h2 className="text-xl font-semibold">Key terms & figures</h2>
                <div className="text-sm opacity-80">Hover definitions, click figures</div>
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-4 border rounded-lg">
                  <h3 className="font-semibold">Helmet Positioning Index (HPI)</h3>
                  <p className="text-sm mt-2">Vertical distance between brow and reference plane. <button onClick={() => setActiveModal('fig1')} className="ml-2 text-orange-500 underline">View figure</button></p>
                </div>

                <div className="p-4 border rounded-lg">
                  <h3 className="font-semibold">Impact points</h3>
                  <p className="text-sm mt-2">Four standardized points: vertical, front, side, back. <button onClick={() => setActiveModal('fig2')} className="ml-2 text-orange-500 underline">View figure</button></p>
                </div>
              </div>
            </section>

            <section id="construction" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-xl font-semibold">Design & Construction requirements (Clause 4.1)</h2>
              <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                {[
                  {k: 'materials', title: 'Materials', text: 'Skin-contact materials must comply with EN ISO 13688 and not cause irritation.'},
                  {k: 'design', title: 'Design', text: 'No sharp edges or internal projections likely to injure wearer.'},
                  {k: 'retention', title: 'Retention system', text: 'Chin strap min width 15 mm; adjustable.'},
                  {k: 'vent', title: 'Ventilation', text: 'Min total ventilation area 4 cm²; pin test must not touch headform.'},
                  {k: 'vision', title: 'Field of vision', text: 'Horiz 105°, up 25°, down 45° (EN 13087-6).'},
                  {k: 'erg', title: 'Ergonomics', text: 'Subjective YES answers required in ergonomics test.'},
                ].map((c) => (
                  <article key={c.k} className="p-4 border rounded-lg relative group">
                    <h4 className="font-semibold">{c.title}</h4>
                    <p className="text-sm mt-2">{c.text}</p>

                    <button
                      className="absolute right-3 bottom-3 text-xs underline"
                      onClick={() => toggleExpand(c.k)}
                    >
                      {expanded[c.k] ? 'Hide tests' : 'Show tests'}
                    </button>

                    <div className={`mt-3 text-sm transition-all ${expanded[c.k] ? 'max-h-96' : 'max-h-0 overflow-hidden'}`}>
                      <div className="text-xs text-gray-600 dark:text-gray-300">
                        {/* Short mapping to test methods */}
                        {c.k === 'materials' && <p>See Test: 5.1 (General examination of material and construction)</p>}
                        {c.k === 'design' && <p>See Test: 5.1 (visual & tactile check)</p>}
                        {c.k === 'retention' && <p>See Test: 5.2 (retention system design) and 5.12 (retention strength)</p>}
                        {c.k === 'vent' && <p>See Test: 5.3 (ventilation pin test)</p>}
                        {c.k === 'vision' && <p>See Test: EN 13087-6 (field of vision)</p>}
                        {c.k === 'erg' && <p>See Test: 5.4 (ergonomics subjective questionnaire)</p>}
                      </div>
                    </div>
                  </article>
                ))}
              </div>
            </section>

            <section id="performance" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-xl font-semibold">Performance requirements (Clause 4.2)</h2>

              <div className="mt-4 space-y-4">
                <div className="p-4 border rounded-lg">
                  <h3 className="font-semibold">Shock absorption</h3>
                  <p className="text-sm mt-2">Peak acceleration must not exceed 250 g (see 5.10). Force transmitted shall not exceed 10 kN (5.9).</p>
                  <details className="mt-2 p-2 bg-gray-50 dark:bg-gray-900 rounded">
                    <summary className="cursor-pointer">Test rig & procedure summary</summary>
                    <p className="text-sm mt-2">Flat and hemispherical strikers (5 kg) used at specified velocities: vertical point at ~6.26 m/s, lateral/front/rear at ~3.13 m/s. Instrumentation CFC600, sampling ≥10 kHz.</p>
                  </details>
                </div>

                <div className="p-4 border rounded-lg">
                  <h3 className="font-semibold">Penetration</h3>
                  <p className="text-sm mt-2">Conical striker test on test block; must not contact block (5.11). Click figure to view test block.</p>
                  <button onClick={() => setActiveModal('fig4')} className="mt-2 underline text-orange-500">View penetration test block</button>
                </div>

                <div className="p-4 border rounded-lg">
                  <h3 className="font-semibold">Retention strength & effectiveness</h3>
                  <p className="text-sm mt-2">Dynamic extension ≤ 35 mm, residual ≤ 25 mm (5.12). Roll-off tests must not remove helmet (5.13).</p>
                  <button onClick={() => setActiveModal('fig5')} className="mt-2 underline text-orange-500">View roll-off apparatus</button>
                </div>
              </div>
            </section>

            <section id="methods" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-xl font-semibold">Test methods — interactive labs (Clause 5)</h2>

              <p className="mt-2 text-sm">Click a test to open a short interactive card with the principle, apparatus summary and required reporting fields.</p>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <TestCard title="Force transmission (5.9)" keyId="5.9" excerpt="Flat & hemispherical strikers, measure max force (10 kN limit)." onOpen={() => setActiveModal('fig2')} />
                <TestCard title="Shock absorption (5.10)" keyId="5.10" excerpt="Falling headform, record gmax (≤250 g)." onOpen={() => setActiveModal('fig3')} />
                <TestCard title="Penetration (5.11)" keyId="5.11" excerpt="Conical striker onto helmet on test block." onOpen={() => setActiveModal('fig4')} />
                <TestCard title="Retention strength (5.12)" keyId="5.12" excerpt="Drop weight test; dynamic/residual extension limits." onOpen={() => setActiveModal('fig5')} />
              </div>

              <div className="mt-6 p-4 border rounded bg-gray-50 dark:bg-gray-900">
                <h4 className="font-semibold">Simulation</h4>
                <p className="text-sm mt-2">Quick simulation: click an action to see a short animation/explanation.</p>
                <div className="mt-3 flex gap-3">
                  <button className="px-3 py-2 rounded border" onClick={() => alert('Simulate: striker drop — velocity, record force (demo)')}>Drop striker (demo)</button>
                  <button className="px-3 py-2 rounded border" onClick={() => alert('Simulate: conical striker penetration check (demo)')}>Penetration demo</button>
                </div>
              </div>
            </section>

            <section id="marking" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-xl font-semibold">Marking (Clause 6) & Manufacturer information (Clause 7)</h2>
              <ul className="list-disc pl-5 mt-3 text-sm space-y-2">
                <li>EN 18100:2025 number — mandatory</li>
                <li>Manufacturer name / trademark</li>
                <li>Model designation, month/year of manufacture</li>
                <li>Helmet size (cm) and type weight (g to nearest 5 g)</li>
              </ul>

              <div className="mt-4 p-4 border rounded">
                <h4 className="font-semibold">Instructions & warnings (to be included)</h4>
                <ol className="list-decimal pl-5 mt-2 text-sm space-y-1">
                  <li>Designation: "Helmets for ski mountaineers"</li>
                  <li>Warning: does not comply with EN 1077 (alpine skiing)</li>
                  <li>Adjustment, cleaning, maintenance, lifespan guidance</li>
                  <li>Warning about replacing helmets after severe impact</li>
                </ol>
              </div>
            </section>

            <section id="annexa" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-xl font-semibold">Annex A — Thermal comfort recommendations</h2>
              <p className="mt-2 text-sm">Recommendations on materials and construction for thermal comfort. Designers should balance ventilation and protection — holes should be oriented so the head is not visible from above.</p>
              <div className="mt-4 p-3 border rounded">
                <h4 className="font-semibold">Interactive airflow demo (concept)</h4>
                <p className="text-sm mt-2">Hover over the helmet schematic to see hotspots (ventilation vs protection trade-offs).</p>
                <div className="mt-3 h-40 rounded bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-700 flex items-center justify-center">Helmet airflow schematic (placeholder)</div>
              </div>
            </section>

            <section id="guide" className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-lg font-semibold">Quick guide</h2>
              <ol className="text-sm mt-2 list-decimal pl-5 space-y-1">
                <li>Upload the 5 figure images into <code>/images/</code> using the filenames listed in the left panel.</li>
                <li>Build the React app (this component expects Tailwind). Deploy to GitHub Pages or your internal host.</li>
                <li>Review each interactive test — link to lab reports or internal QC templates for team use.</li>
              </ol>
            </section>
          </section>
        </main>

        <footer className="p-6 text-center text-xs text-gray-500">Interactive memo generated for Petzl regulatory compliance — EN 18100:2025 (English)</footer>

        {/* Modals for figures */}
        {activeModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setActiveModal(null)}>
            <div className="bg-white dark:bg-gray-900 rounded-lg max-w-3xl w-full p-4" onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-start">
                <h3 className="font-semibold">Figure</h3>
                <button onClick={() => setActiveModal(null)} className="text-sm underline">Close</button>
              </div>
              <div className="mt-4">
                <img src={images[activeModal]} alt={activeModal} className="w-full h-auto object-contain" />
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


function TestCard({ title, excerpt, onOpen }) {
  return (
    <div className="p-4 border rounded-lg hover:shadow-md transition">
      <h4 className="font-semibold">{title}</h4>
      <p className="text-sm mt-2">{excerpt}</p>
      <div className="mt-3 flex gap-2">
        <button onClick={onOpen} className="px-3 py-1 rounded bg-orange-500 text-white text-sm">Open figure</button>
        <button onClick={() => alert('Open test procedure (link to clause in full memo)')} className="px-3 py-1 rounded border text-sm">Open procedure</button>
      </div>
    </div>
  );
}
